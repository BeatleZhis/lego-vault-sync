# lego-vault-sync

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è wildcard) —á–µ—Ä–µ–∑ Lego –∏ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ HashiCorp Vault —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- [–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã](#dns-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Vault](#vault)
- [–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Vault](#–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è-–≤-vault)
  - [AppRole (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±)](#approle-—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π-—Å–ø–æ—Å–æ–±)
  - [Token (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)](#token-—Ç–æ–ª—å–∫–æ-–¥–ª—è-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `config.example.yaml`. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ `config.yaml` –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã:

```bash
cp config.example.yaml config.yaml
```

## DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

–°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Lego](https://go-acme.github.io/lego/dns/).

### –ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ Regru:
1. –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –∫–æ–¥ `regru` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Regru](https://go-acme.github.io/lego/dns/regru/)

```yaml
DNSProvider: regru
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
# REGRU_USERNAME, REGRU_PASSWORD
```

## Vault

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

–°–æ–∑–¥–∞–π—Ç–µ secret engine –≤ Vault –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ KV v2 —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –ø—É—Ç–∏ tls
vault secrets enable -path=tls kv-v2
```

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:

`tls/data/example.com` - —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á –¥–ª—è example.com

`tls/data/*.example.com` - —Å–æ–¥–µ—Ä–∂–∏—Ç wildcard —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Vault

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: `approle` –∏ `token`.

### AppRole (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±)

1. –í–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é AppRole
```
vault auth enable approle
```
2. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–∞:
```
echo 'path "tls/*" { capabilities = ["read", "list", "update", "create"] }' | vault policy write lego-tls-policy -
```
3. –°–æ–∑–¥–∞–π—Ç–µ —Ä–æ–ª—å:
```
# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π
vault write auth/approle/role/lego-approle token_policies="lego-tls-policy"

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
vault write auth/approle/role/lego-approle \
    token_policies="lego-tls-policy" \
    token_ttl=24h \
    token_max_ttl=168h
```
4. –ü–æ–ª—É—á–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```
# –ü–æ–ª—É—á–µ–Ω–∏–µ RoleID
vault read auth/approle/role/lego-approle/role-id

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SecretID
vault write -force auth/approle/role/lego-approle/secret-id```
```
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ config.yaml:

```yaml
vault:
  address: "https://vault.example.com:8800/"
  authType: approle
  roleID: aaabbbbbcccc
  secretID: 111111111222
  mountPath: tls
  requestTimeout: 60
```

### Token (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
‚ö†Ô∏è –í–∞–∂–Ω–æ: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏! –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ config.yaml:

```yaml
vault:
  address: "https://vault.example.com:8800/"
  authType: token
  token: "aaabbbbbcccc"
  mountPath: tls
  requestTimeout: 60
```

# –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ Vault
2. –ó–∞–ø—Ä–æ—Å –Ω–æ–≤—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ - –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —á–µ—Ä–µ–∑ Lego
3. DNS-–≤–∞–ª–∏–¥–∞—Ü–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–ª–∞–¥–µ–Ω–∏—è –¥–æ–º–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Vault - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Vault
5. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

# Docker
–°–æ–±—Ä–∞—Ç—å –≤ docker –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã ```docker build . -t lego-vault-sync```